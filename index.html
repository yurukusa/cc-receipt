<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>cc-receipt ‚Äî AI Work Receipt</title>
  <style>
    :root {
      --bg: #0d1117; --surface: #161b22; --surface2: #21262d;
      --border: #30363d; --text: #e6edf3; --muted: #8b949e;
      --orange: #f0883e; --green: #3fb950; --cyan: #58d8f0;
      --yellow: #d29922; --red: #f85149; --purple: #d2a8ff;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: var(--bg); color: var(--text); font-family: ui-monospace,monospace; font-size: 13px; line-height: 1.5; min-height: 100vh; }
    header { background: var(--surface); border-bottom: 1px solid var(--border); padding: 14px 20px; display: flex; align-items: center; gap: 12px; }
    header h1 { font-size: 16px; }
    header .badge { background: var(--orange); color: #fff; font-size: 11px; padding: 2px 6px; border-radius: 4px; font-weight: 600; }
    .main { padding: 20px; max-width: 700px; margin: 0 auto; }
    .drop-zone { border: 2px dashed var(--border); border-radius: 8px; padding: 40px; text-align: center; cursor: pointer; transition: border-color .2s,background .2s; margin-bottom: 20px; }
    .drop-zone:hover,.drop-zone.drag-over { border-color: var(--orange); background: rgba(240,136,62,.05); }
    .drop-zone input { display: none; }
    .drop-zone h2 { font-size: 15px; margin-bottom: 8px; }
    .drop-zone p { color: var(--muted); font-size: 12px; }
    .drop-zone .icon { font-size: 32px; margin-bottom: 12px; }
    #output { display: none; }
    .controls { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
    .date-select { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 5px 10px; border-radius: 4px; font-family: inherit; font-size: 13px; }
    .nav-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; }
    .nav-btn:hover { border-color: var(--orange); }
    .sleep-input { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 4px 8px; border-radius: 4px; width: 50px; font-family: inherit; font-size: 12px; }
    .clear-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); padding: 4px 10px; border-radius: 4px; cursor: pointer; font-family: inherit; font-size: 12px; margin-left: auto; }
    /* Receipt styling */
    .receipt-wrap { display: flex; justify-content: center; }
    .receipt {
      background: #1a1f27;
      border: 1px solid var(--border);
      border-radius: 4px;
      width: 360px;
      font-family: 'Courier New', Courier, monospace;
      font-size: 13px;
      padding: 0;
      position: relative;
      box-shadow: 0 4px 24px rgba(0,0,0,.4);
    }
    /* Torn-edge effect at top */
    .receipt-top { height: 16px; background: var(--bg); clip-path: polygon(0 0,4% 100%,8% 0,12% 100%,16% 0,20% 100%,24% 0,28% 100%,32% 0,36% 100%,40% 0,44% 100%,48% 0,52% 100%,56% 0,60% 100%,64% 0,68% 100%,72% 0,76% 100%,80% 0,84% 100%,88% 0,92% 100%,96% 0,100% 100%,100% 0); }
    .receipt-body { padding: 16px 20px 20px; }
    .receipt-bottom { height: 16px; background: var(--bg); clip-path: polygon(0 100%,4% 0,8% 100%,12% 0,16% 100%,20% 0,24% 100%,28% 0,32% 100%,36% 0,40% 100%,44% 0,48% 100%,52% 0,56% 100%,60% 0,64% 100%,68% 0,72% 100%,76% 0,80% 100%,84% 0,88% 100%,92% 0,96% 100%,100% 0,100% 100%); }
    .r-center { text-align: center; }
    .r-title { font-size: 14px; font-weight: bold; letter-spacing: 2px; color: var(--text); margin-bottom: 2px; }
    .r-subtitle { font-size: 11px; color: var(--muted); margin-bottom: 12px; }
    .r-divider { border: none; border-top: 1px dashed var(--border); margin: 8px 0; }
    .r-divider-solid { border: none; border-top: 1px solid var(--border); margin: 8px 0; }
    .r-section-title { text-align: center; font-size: 11px; letter-spacing: 1px; color: var(--muted); margin: 8px 0 6px; }
    .r-project { margin-bottom: 6px; }
    .r-proj-row { display: flex; justify-content: space-between; align-items: baseline; }
    .r-proj-name { color: var(--text); font-size: 13px; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .r-proj-time { color: var(--orange); font-size: 13px; font-weight: bold; }
    .r-proj-detail { color: var(--muted); font-size: 11px; margin-left: 16px; }
    .r-stat-row { display: flex; justify-content: space-between; margin: 4px 0; font-size: 13px; }
    .r-stat-label { color: var(--muted); }
    .r-stat-value { color: var(--text); font-weight: bold; }
    .r-total-row { display: flex; justify-content: space-between; font-size: 14px; font-weight: bold; }
    .r-total-label { color: var(--cyan); }
    .r-total-value { color: var(--cyan); }
    .r-sleep-row { display: flex; justify-content: space-between; font-size: 12px; }
    .r-sleep-label { color: var(--muted); }
    .r-sleep-value { color: var(--muted); }
    .r-footer { text-align: center; margin-top: 12px; }
    .r-footer-main { font-size: 12px; color: var(--green); font-weight: bold; letter-spacing: 1px; }
    .r-footer-sub { font-size: 10px; color: var(--muted); margin-top: 2px; }
    .r-ghost { text-align: center; padding: 16px; }
    .r-ghost-emoji { font-size: 28px; margin-bottom: 8px; }
    .r-ghost-title { color: var(--red); font-size: 13px; font-weight: bold; margin-bottom: 4px; }
    .r-ghost-desc { color: var(--muted); font-size: 11px; }
    /* Share button */
    .share-row { display: flex; justify-content: center; gap: 10px; margin-top: 16px; }
    .share-btn { background: var(--surface2); border: 1px solid var(--border); color: var(--text); padding: 6px 16px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: inherit; }
    .share-btn:hover { border-color: var(--orange); color: var(--orange); }
    .copy-notice { text-align: center; font-size: 11px; color: var(--green); margin-top: 6px; height: 16px; }
  </style>
</head>
<body>
<header>
  <h1>üßæ cc-receipt</h1>
  <span class="badge">AI Work Receipt</span>
</header>
<div class="main">
  <div class="drop-zone" id="dropZone">
    <input type="file" id="fileInput" webkitdirectory multiple accept=".md">
    <div class="icon">üìÇ</div>
    <h2>Select your proof-log folder</h2>
    <p>Click to select the folder ‚Äî usually at <code>~/ops/proof-log/</code><br>
    Contains <code>YYYY-MM-DD.md</code> files with your AI session records.<br>
    Processed entirely in your browser. Nothing is uploaded.</p>
    <p style="margin-top:12px;font-size:11px;color:var(--muted)">Don't have a proof-log yet? ‚Üí <a href="https://yurukusa.github.io/cc-ops-kit-landing/" target="_blank" style="color:var(--orange)">cc-ops-kit</a> sets it up automatically ($19)</p>
  </div>

  <div id="output">
    <div class="controls">
      <button class="nav-btn" id="prevDay">‚óÄ</button>
      <select class="date-select" id="dateSelect"></select>
      <button class="nav-btn" id="nextDay">‚ñ∂</button>
      <label style="color:var(--muted);font-size:12px;margin-left:8px">Sleep:</label>
      <input type="number" class="sleep-input" id="sleepInput" value="7" min="0" max="23">
      <label style="color:var(--muted);font-size:12px">h</label>
      <button class="clear-btn" id="clearBtn">‚úï Clear</button>
    </div>

    <div class="receipt-wrap">
      <div class="receipt">
        <div class="receipt-top"></div>
        <div class="receipt-body" id="receiptBody"></div>
        <div class="receipt-bottom"></div>
      </div>
    </div>

    <div class="share-row">
      <button class="share-btn" id="copyTextBtn">üìã Copy as text</button>
      <button class="share-btn" id="copyTweetBtn">üê¶ Copy tweet</button>
    </div>
    <div class="copy-notice" id="copyNotice"></div>
  </div>
</div>

<script>
const SESSION_HEADER = /^###\s+(\d{4}-\d{2}-\d{2})\s+(\d{2}:\d{2})-(\d{2}:\d{2})\s+JST/;
const WHERE_LINE     = /^-\s+„Å©„Åì„Åß:\s+(.+)$/;
const DURATION_LINE  = /^-\s+„ÅÑ„Å§:.+JSTÔºà(\d+)ÂàÜÔºâ/;
const WHAT_LINE      = /^-\s+‰Ωï„Çí:\s+(\d+)„Éï„Ç°„Ç§„É´Â§âÊõ¥\s+\(\+(\d+)\/-(\d+)\)/;
const WHO_LINE       = /^-\s+Ë™∞„Åå:\s+CC:\s+(\d+)‰ª∂/;

function parseProofLog(content) {
  const sessions = [];
  let cur = null;
  for (const raw of content.split('\n')) {
    const line = raw.trim();
    if (SESSION_HEADER.exec(line)) {
      if (cur) sessions.push(cur);
      cur = { durationMin: 0, project: null, ccActions: 0, filesChanged: 0, linesAdded: 0, linesRemoved: 0 };
      continue;
    }
    if (!cur) continue;
    const dur = DURATION_LINE.exec(line); if (dur) { cur.durationMin = parseInt(dur[1]); continue; }
    const whe = WHERE_LINE.exec(line);    if (whe) { cur.project = whe[1].trim(); continue; }
    const wha = WHAT_LINE.exec(line);     if (wha) { cur.filesChanged = parseInt(wha[1]); cur.linesAdded = parseInt(wha[2]); cur.linesRemoved = parseInt(wha[3]); continue; }
    const who = WHO_LINE.exec(line);      if (who) { cur.ccActions = parseInt(who[1]); continue; }
  }
  if (cur) sessions.push(cur);
  return sessions;
}

function aggregate(sessions) {
  const byProj = {};
  let totalMin = 0, totalSessions = 0, totalLines = 0, totalFiles = 0;
  for (const s of sessions) {
    if (!s.project) continue;
    totalSessions++; totalMin += s.durationMin;
    totalLines += s.linesAdded; totalFiles += s.filesChanged;
    if (!byProj[s.project]) byProj[s.project] = { mins: 0, sessions: 0, lines: 0, files: 0 };
    const p = byProj[s.project];
    p.mins += s.durationMin; p.sessions++; p.lines += s.linesAdded; p.files += s.filesChanged;
  }
  const projects = Object.entries(byProj).sort((a,b) => b[1].mins - a[1].mins);
  return { projects, totalMin, totalSessions, totalLines, totalFiles };
}

function fmtDur(m) {
  const h = Math.floor(m/60), mm = m%60;
  if (h === 0) return `${mm}m`;
  if (mm === 0) return `${h}h`;
  return `${h}h ${String(mm).padStart(2,'0')}m`;
}

function fmtNum(n) { return n.toLocaleString(); }

function dayName(d) {
  const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
  return days[new Date(d + 'T12:00:00Z').getDay()];
}

function monthName(d) {
  const [y,m,dd] = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(m)-1]} ${parseInt(dd)}, ${y}`;
}

let byDate = {};
let dates = [];
let currentDateIdx = 0;
let sleepH = 7;

function loadFiles(files) {
  byDate = {};
  const mdFiles = [...files].filter(f => /^\d{4}-\d{2}-\d{2}\.md$/.test(f.name));
  if (mdFiles.length === 0) { alert('No YYYY-MM-DD.md files found. Please select your proof-log folder.'); return; }
  let pending = mdFiles.length;
  for (const f of mdFiles) {
    const dateKey = f.name.replace('.md', '');
    const reader = new FileReader();
    reader.onload = e => {
      byDate[dateKey] = parseProofLog(e.target.result);
      if (--pending === 0) finalize();
    };
    reader.readAsText(f);
  }
}

function finalize() {
  dates = Object.keys(byDate).sort().reverse();
  if (dates.length === 0) return;
  const sel = document.getElementById('dateSelect');
  sel.innerHTML = dates.map(d => `<option value="${d}">${d} (${dayName(d)})</option>`).join('');
  currentDateIdx = 0;
  document.getElementById('dropZone').style.display = 'none';
  document.getElementById('output').style.display = 'block';
  renderDate(dates[0]);
}

function renderDate(date) {
  const sessions = byDate[date] || [];
  const { projects, totalMin, totalSessions, totalLines, totalFiles } = aggregate(sessions);
  const body = document.getElementById('receiptBody');
  const aiSleepH = Math.max(0, 24 - Math.ceil(totalMin / 60));
  const workedWhileYouSlept = totalMin > (24 - sleepH) * 60 || aiSleepH < sleepH;

  if (projects.length === 0) {
    body.innerHTML = `
      <div class="r-center r-title">AI  WORK  RECEIPT</div>
      <div class="r-center r-subtitle">${monthName(date)}&nbsp;&nbsp;(${dayName(date)})</div>
      <hr class="r-divider-solid">
      <div class="r-ghost">
        <div class="r-ghost-emoji">üëª</div>
        <div class="r-ghost-title">GHOST DAY</div>
        <div class="r-ghost-desc">AI worked autonomously.<br>No sessions logged.</div>
      </div>`;
    return;
  }

  let projHtml = '';
  for (const [name, p] of projects) {
    const display = name.length > 20 ? name.slice(0,18)+'‚Ä¶' : name;
    projHtml += `
      <div class="r-project">
        <div class="r-proj-row">
          <span class="r-proj-name">${escHtml(display)}</span>
          <span class="r-proj-time">${fmtDur(p.mins)}</span>
        </div>
        <div class="r-proj-detail">‚Ü≥ ${p.sessions} sessions&nbsp;&nbsp;+${fmtNum(p.lines)} lines</div>
      </div>`;
  }

  const sleepCompare = workedWhileYouSlept
    ? `<div class="r-center" style="color:var(--red);font-size:12px;font-weight:bold;margin-top:8px">AI WORKED WHILE YOU SLEPT</div>`
    : `<div class="r-center" style="color:var(--muted);font-size:11px;margin-top:8px">AI rest: ${aiSleepH}h&nbsp;&nbsp;Your sleep: ${sleepH}h</div>`;

  body.innerHTML = `
    <div class="r-center r-title">AI  WORK  RECEIPT</div>
    <div class="r-center r-subtitle">${monthName(date)}&nbsp;&nbsp;(${dayName(date)})</div>
    <hr class="r-divider-solid">
    <div class="r-section-title">‚Äî PROJECTS ‚Äî</div>
    ${projHtml}
    <hr class="r-divider">
    <div class="r-stat-row">
      <span class="r-total-label">AI ACTIVE TIME</span>
      <span class="r-total-value">${fmtDur(totalMin)}</span>
    </div>
    <div class="r-stat-row">
      <span class="r-stat-label">SESSIONS</span>
      <span class="r-stat-value">${totalSessions}</span>
    </div>
    <div class="r-stat-row">
      <span class="r-stat-label">LINES ADDED</span>
      <span class="r-stat-value">+${fmtNum(totalLines)}</span>
    </div>
    <div class="r-stat-row">
      <span class="r-stat-label">FILES TOUCHED</span>
      <span class="r-stat-value">${fmtNum(totalFiles)}</span>
    </div>
    <hr class="r-divider">
    <div class="r-sleep-row">
      <span class="r-sleep-label">YOUR SLEEP</span>
      <span class="r-sleep-value">${sleepH}h</span>
    </div>
    <div class="r-sleep-row">
      <span class="r-sleep-label">AI SLEEP</span>
      <span class="r-sleep-value">${aiSleepH <= 0 ? '0m' : aiSleepH+'h'}</span>
    </div>
    ${sleepCompare}
    <hr class="r-divider-solid">
    <div class="r-footer">
      <div class="r-footer-main">THE AI NEVER CLOCKS OUT</div>
      <div class="r-footer-sub">Generated by cc-receipt ¬∑ yurukusa.github.io/cc-receipt</div>
    </div>`;

  // Store for copy
  window._receiptData = { date, totalMin, totalSessions, totalLines, projects, sleepH, aiSleepH, workedWhileYouSlept };
}

function escHtml(s) { return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

function copyText() {
  const d = window._receiptData;
  if (!d) return;
  const W = 38;
  function center(s) { const pad = Math.max(0, W - s.length); return ' '.repeat(Math.floor(pad/2)) + s; }
  function row(l,r) { const sp = Math.max(1, W - l.length - r.length); return l + ' '.repeat(sp) + r; }
  const lines = [
    '‚ïî' + '‚ïê'.repeat(W) + '‚ïó',
    '‚ïë' + center('AI  WORK  RECEIPT') + '‚ïë',
    '‚ïë' + center(`${monthName(d.date)}  (${dayName(d.date)})`) + '‚ïë',
    '‚ï†' + '‚ïê'.repeat(W) + '‚ï£',
    '‚ïë' + center('‚Äî PROJECTS ‚Äî') + '‚ïë',
  ];
  for (const [name, p] of d.projects) {
    const n = name.slice(0,20);
    const t = fmtDur(p.mins);
    lines.push('‚ïë ' + row(n, t) + ' ‚ïë');
    const det = `‚Ü≥ ${p.sessions} sessions  +${fmtNum(p.lines)} lines`;
    lines.push('‚ïë   ' + det.padEnd(W-3) + '‚ïë');
  }
  lines.push('‚ïü' + '‚îÄ'.repeat(W) + '‚ï¢');
  lines.push('‚ïë ' + row('AI ACTIVE TIME', fmtDur(d.totalMin)) + ' ‚ïë');
  lines.push('‚ïë ' + row('SESSIONS', String(d.totalSessions)) + ' ‚ïë');
  lines.push('‚ïë ' + row('LINES ADDED', '+'+fmtNum(d.totalLines)) + ' ‚ïë');
  if (d.workedWhileYouSlept) {
    lines.push('‚ïü' + '‚îÄ'.repeat(W) + '‚ï¢');
    lines.push('‚ïë' + center('AI WORKED WHILE YOU SLEPT') + '‚ïë');
  }
  lines.push('‚ïö' + '‚ïê'.repeat(W) + '‚ïù');
  navigator.clipboard.writeText(lines.join('\n')).then(() => flash('Copied!'));
}

function copyTweet() {
  const d = window._receiptData;
  if (!d) return;
  const top = d.projects[0];
  const extra = d.workedWhileYouSlept ? '\nüëª AI worked while I slept.' : '';
  const text = `üßæ AI Work Receipt ‚Äî ${d.date}\n\nTop: ${top[0]} ${fmtDur(top[1].mins)}\nTotal: ${fmtDur(d.totalMin)} | ${d.totalSessions} sessions | +${fmtNum(d.totalLines)} lines${extra}\n\n#ClaudeCode #AIReceipt\nhttps://yurukusa.github.io/cc-receipt/`;
  navigator.clipboard.writeText(text).then(() => flash('Tweet text copied!'));
}

function flash(msg) {
  const n = document.getElementById('copyNotice');
  n.textContent = msg;
  setTimeout(() => { n.textContent = ''; }, 2000);
}

function fmtDur(m) {
  const h = Math.floor(m/60), mm = m%60;
  if (h === 0) return `${mm}m`;
  if (mm === 0) return `${h}h`;
  return `${h}h ${String(mm).padStart(2,'0')}m`;
}
function dayName(d) { const days = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat']; return days[new Date(d + 'T12:00:00Z').getDay()]; }
function monthName(d) { const [y,m,dd] = d.split('-'); const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec']; return `${months[parseInt(m)-1]} ${parseInt(dd)}, ${y}`; }
function fmtNum(n) { return n.toLocaleString(); }

// Events
const dz = document.getElementById('dropZone');
const fi = document.getElementById('fileInput');
dz.addEventListener('click', () => fi.click());
dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('drag-over'); });
dz.addEventListener('dragleave', () => dz.classList.remove('drag-over'));
dz.addEventListener('drop', e => { e.preventDefault(); dz.classList.remove('drag-over'); loadFiles(e.dataTransfer.files); });
fi.addEventListener('change', () => fi.files.length && loadFiles(fi.files));
document.getElementById('dateSelect').addEventListener('change', e => {
  currentDateIdx = dates.indexOf(e.target.value);
  renderDate(e.target.value);
});
document.getElementById('prevDay').addEventListener('click', () => {
  if (currentDateIdx < dates.length-1) { currentDateIdx++; document.getElementById('dateSelect').value = dates[currentDateIdx]; renderDate(dates[currentDateIdx]); }
});
document.getElementById('nextDay').addEventListener('click', () => {
  if (currentDateIdx > 0) { currentDateIdx--; document.getElementById('dateSelect').value = dates[currentDateIdx]; renderDate(dates[currentDateIdx]); }
});
document.getElementById('sleepInput').addEventListener('change', e => {
  sleepH = Math.max(0, Math.min(23, parseInt(e.target.value) || 7));
  if (dates[currentDateIdx]) renderDate(dates[currentDateIdx]);
});
document.getElementById('clearBtn').addEventListener('click', () => {
  byDate = {}; dates = []; currentDateIdx = 0;
  document.getElementById('dropZone').style.display = 'block';
  document.getElementById('output').style.display = 'none';
});
document.getElementById('copyTextBtn').addEventListener('click', copyText);
document.getElementById('copyTweetBtn').addEventListener('click', copyTweet);
</script>
</body>
</html>
